<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Jackpot Joker</title>
    <style>
        :root {
            --bg: radial-gradient(circle at top, #1f1147 0%, #090417 55%, #05010d 100%);
            --surface: rgba(20, 12, 48, 0.92);
            --surface-strong: rgba(36, 20, 86, 0.95);
            --primary: #ff7bff;
            --primary-strong: #f64bff;
            --accent: #00e7ff;
            --accent-soft: rgba(0, 231, 255, 0.18);
            --gold: #ffd166;
            --text: #f6ecff;
            --muted: rgba(246, 236, 255, 0.62);
            --shadow: 0 14px 40px rgba(5, 3, 17, 0.55);
            --radius-lg: 24px;
            --radius-md: 18px;
            --radius-sm: 12px;
            --space-xs: 0.375rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --max-width: 680px;
            font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            min-height: 100%;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
        }

        body {
            display: flex;
            justify-content: center;
            padding: var(--space-md);
        }

        #app {
            width: min(100%, var(--max-width));
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            padding: var(--space-lg) var(--space-md) calc(var(--space-lg) * 1.4);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        #app::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 123, 255, 0.18), rgba(0, 231, 255, 0.12));
            pointer-events: none;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-md);
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.65rem, 5vw, 2.2rem);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            text-shadow: 0 0 12px rgba(255, 123, 255, 0.6);
        }

        .icon-button {
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border-radius: 999px;
            padding: 0.5rem 0.85rem;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            touch-action: manipulation;
        }

        .icon-button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 3px;
        }

        .icon-button:hover {
            background: rgba(255, 255, 255, 0.16);
        }

        .info-text {
            font-size: 0.85rem;
            color: var(--muted);
            margin: 0;
        }

        #scoreboard {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: var(--space-sm);
        }

        .score-card {
            background: rgba(255, 255, 255, 0.04);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .score-card h2 {
            margin: 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .score-card span {
            font-size: clamp(1.35rem, 5vw, 1.75rem);
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-sm);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        #joker-tray {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            overflow-x: auto;
            padding-bottom: 0.4rem;
            scroll-snap-type: x proximity;
        }

        #joker-tray::-webkit-scrollbar {
            height: 6px;
        }

        #joker-tray::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 999px;
        }

        .joker-empty {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .chip {
            background: rgba(0, 231, 255, 0.12);
            border: 1px solid rgba(0, 231, 255, 0.24);
            color: var(--accent);
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            letter-spacing: 0.06em;
        }

        #reel-summary {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        #hand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: var(--space-sm);
        }

        .card {
            position: relative;
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            background: var(--surface-strong);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 14px 20px rgba(3, 1, 12, 0.35);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            text-align: center;
            min-height: 130px;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
            pointer-events: none;
        }

        .card-icon {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
        }

        .card-name {
            font-weight: 700;
            letter-spacing: 0.08em;
            font-size: 0.95rem;
        }

        .card-desc {
            font-size: 0.75rem;
            color: var(--muted);
            line-height: 1.3;
        }

        .hand-card {
            border: none;
            cursor: pointer;
            touch-action: manipulation;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border 0.18s ease;
        }

        .hand-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 4px;
        }

        .hand-card.selected {
            transform: translateY(-6px) scale(1.02);
            border: 2px solid var(--primary);
            box-shadow: 0 18px 30px rgba(255, 123, 255, 0.32);
        }

        #card-details {
            font-size: 0.85rem;
            color: var(--muted);
            min-height: 2.2rem;
        }

        #payline-track {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: var(--space-sm);
        }

        .payline-slot {
            position: relative;
            border-radius: var(--radius-sm);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            min-height: 120px;
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .payline-slot .card {
            width: 100%;
            min-height: 120px;
        }

        .payline-slot.win {
            border-color: rgba(255, 209, 102, 0.65);
            box-shadow: 0 0 18px rgba(255, 209, 102, 0.32);
        }

        #message-bar {
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.95rem;
            color: var(--text);
            padding: 0.3rem 0.5rem;
        }

        #action-bar {
            position: sticky;
            bottom: 0;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: var(--space-sm);
            padding-top: var(--space-sm);
        }

        .action-button {
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.95rem;
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #130722;
            box-shadow: 0 16px 30px rgba(0, 231, 255, 0.25);
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            touch-action: manipulation;
        }

        .action-button:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 3px;
        }

        .action-button:active:not(:disabled) {
            transform: translateY(1px) scale(0.99);
        }

        .action-button:disabled {
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.4);
            box-shadow: none;
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg) var(--space-md);
            background: rgba(6, 3, 18, 0.72);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .modal[hidden] {
            display: none;
        }

        .modal-card {
            width: min(100%, 520px);
            background: var(--surface-strong);
            border-radius: var(--radius-lg);
            padding: var(--space-lg) var(--space-md);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
        }

        .modal-card h2 {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 1.2rem;
        }

        .modal-card p {
            margin: 0;
            line-height: 1.6;
            color: var(--muted);
        }

        .modal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: flex-end;
        }

        .pill-button {
            border: none;
            border-radius: 999px;
            padding: 0.55rem 1.25rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.12);
            color: var(--text);
            touch-action: manipulation;
        }

        .pill-button.primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #130722;
        }

        .shop-grid {
            display: grid;
            gap: var(--space-sm);
        }

        .shop-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.08);
            align-items: center;
        }

        .shop-info {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .shop-info strong {
            font-size: 1rem;
        }

        .shop-status {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .shop-buy {
            margin-top: 0.35rem;
            align-self: flex-start;
            border: none;
            border-radius: 999px;
            padding: 0.45rem 1rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.18);
            color: var(--text);
        }

        .shop-buy:disabled {
            cursor: not-allowed;
            opacity: 0.45;
        }

        #reel-picker {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: var(--space-sm);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .reel-picker-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .reel-button {
            flex: 1;
            min-width: 120px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 231, 255, 0.3);
            background: rgba(0, 231, 255, 0.12);
            color: var(--accent);
            padding: 0.6rem 0.9rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
        }

        .reel-button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .reel-cancel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: var(--muted);
        }

        .end-summary {
            display: grid;
            gap: var(--space-sm);
            text-align: center;
        }

        .end-summary h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--muted);
            letter-spacing: 0.08em;
        }

        .end-summary span {
            font-size: 1.65rem;
            font-weight: 700;
        }

        body.modal-open {
            overflow: hidden;
        }

        @media (min-width: 768px) {
            #scoreboard {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }

            #action-bar {
                position: static;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                transition-duration: 0.01ms !important;
                animation-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div>
                <h1>Jackpot Joker</h1>
                <p class="info-text">Reach the target score before you run out of draws.</p>
            </div>
            <button class="icon-button" id="help-button" type="button">Rules</button>
        </header>

        <section id="scoreboard">
            <div class="score-card">
                <h2>Score</h2>
                <span id="score-value">0 / 100</span>
            </div>
            <div class="score-card">
                <h2>Draws Left</h2>
                <span id="draws-value">8</span>
            </div>
            <div class="score-card">
                <h2>Blind</h2>
                <span id="blind-value">1</span>
            </div>
            <div class="score-card">
                <h2>Coins</h2>
                <span id="money-value">$0</span>
            </div>
        </section>

        <section class="panel" aria-labelledby="joker-title">
            <div class="panel-header">
                <h2 id="joker-title">Jokers</h2>
                <span class="chip" id="joker-count">0 owned</span>
            </div>
            <div id="joker-tray" aria-live="polite"></div>
        </section>

        <section class="panel" aria-labelledby="reel-title">
            <div class="panel-header">
                <h2 id="reel-title">Reels</h2>
                <span class="info-text">More symbols mean better odds when drawing.</span>
            </div>
            <div id="reel-summary"></div>
        </section>

        <section class="panel" aria-labelledby="hand-title">
            <div class="panel-header">
                <h2 id="hand-title">Your Hand</h2>
                <span class="chip" id="selection-status">Select 3 cards</span>
            </div>
            <div id="hand-grid" aria-live="polite"></div>
            <div id="card-details"></div>
        </section>

        <section class="panel" aria-labelledby="payline-title">
            <div class="panel-header">
                <h2 id="payline-title">Last Payline</h2>
                <span class="info-text" id="payline-info">Play a hand to see results.</span>
            </div>
            <div id="payline-track"></div>
        </section>

        <div id="message-bar" aria-live="polite"></div>

        <footer id="action-bar">
            <button id="draw-button" class="action-button" type="button">Draw Hand</button>
            <button id="play-button" class="action-button" type="button">Play Selected</button>
        </footer>
    </div>

    <div class="modal" id="help-modal" hidden>
        <div class="modal-card">
            <h2>How to Play</h2>
            <p>Select exactly three cards from your hand to play the payline. Matching symbols award score and coins. Diamonds double winning scores.</p>
            <p>After each blind you survive, visit the shop to add new symbols or jokers to your build. Jokers provide powerful bonuses every hand.</p>
            <ul>
                <li>Tap <strong>Draw Hand</strong> to spend a draw and reveal 5 cards.</li>
                <li>Tap cards to select or deselect them. You need exactly three selected to play.</li>
                <li>Tap <strong>Play Selected</strong> to score the hand.</li>
                <li>Reach the target score before your draws run out to move on.</li>
            </ul>
            <div class="modal-actions">
                <button class="pill-button primary" id="close-help" type="button">Got it</button>
            </div>
        </div>
    </div>

    <div class="modal" id="shop-modal" hidden aria-live="polite">
        <div class="modal-card">
            <h2>Card Shop</h2>
            <p id="shop-intro">Upgrade your build before the next blind.</p>
            <p><strong>Coins:</strong> <span id="shop-money">$0</span></p>
            <div id="shop-items" class="shop-grid"></div>
            <div id="shop-empty" class="info-text" hidden>Nothing new for sale this time. Enjoy the free rest!</div>
            <div id="reel-picker" hidden>
                <strong id="reel-picker-name">Choose a reel</strong>
                <div class="reel-picker-buttons">
                    <button type="button" class="reel-button" data-reel="0">Reel 1</button>
                    <button type="button" class="reel-button" data-reel="1">Reel 2</button>
                    <button type="button" class="reel-button" data-reel="2">Reel 3</button>
                    <button type="button" class="reel-button reel-cancel" id="reel-cancel">Cancel</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="pill-button" id="skip-shop" type="button">Skip Shop</button>
                <button class="pill-button primary" id="shop-continue" type="button">Next Blind</button>
            </div>
        </div>
    </div>

    <div class="modal" id="end-modal" hidden>
        <div class="modal-card end-summary">
            <h2 id="end-title">Run Complete</h2>
            <p id="end-message">Well played!</p>
            <div>
                <h3>Highest Blind</h3>
                <span id="end-blind">1</span>
            </div>
            <div>
                <h3>Final Coins</h3>
                <span id="end-coins">$0</span>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="pill-button primary" id="restart-button" type="button">Play Again</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            scoreValue: document.getElementById('score-value'),
            drawsValue: document.getElementById('draws-value'),
            blindValue: document.getElementById('blind-value'),
            moneyValue: document.getElementById('money-value'),
            jokerTray: document.getElementById('joker-tray'),
            jokerCount: document.getElementById('joker-count'),
            reelSummary: document.getElementById('reel-summary'),
            handGrid: document.getElementById('hand-grid'),
            selectionStatus: document.getElementById('selection-status'),
            cardDetails: document.getElementById('card-details'),
            paylineTrack: document.getElementById('payline-track'),
            paylineInfo: document.getElementById('payline-info'),
            messageBar: document.getElementById('message-bar'),
            drawButton: document.getElementById('draw-button'),
            playButton: document.getElementById('play-button'),
            helpButton: document.getElementById('help-button'),
            helpModal: document.getElementById('help-modal'),
            closeHelp: document.getElementById('close-help'),
            shopModal: document.getElementById('shop-modal'),
            shopIntro: document.getElementById('shop-intro'),
            shopMoney: document.getElementById('shop-money'),
            shopItems: document.getElementById('shop-items'),
            shopEmpty: document.getElementById('shop-empty'),
            shopContinue: document.getElementById('shop-continue'),
            skipShop: document.getElementById('skip-shop'),
            reelPicker: document.getElementById('reel-picker'),
            reelPickerName: document.getElementById('reel-picker-name'),
            reelPickerButtons: document.querySelectorAll('.reel-button[data-reel]'),
            reelCancel: document.getElementById('reel-cancel'),
            endModal: document.getElementById('end-modal'),
            endTitle: document.getElementById('end-title'),
            endMessage: document.getElementById('end-message'),
            endBlind: document.getElementById('end-blind'),
            endCoins: document.getElementById('end-coins'),
            restartButton: document.getElementById('restart-button'),
        };

        const cardPool = {
            cherry: { id: 'cherry', name: 'Cherry', type: 'symbol', icon: '🍒', desc: 'Classic low-tier symbol.', cost: 4 },
            bell: { id: 'bell', name: 'Bell', type: 'symbol', icon: '🔔', desc: 'Rings in decent payouts.', cost: 6 },
            bar: { id: 'bar', name: 'BAR', type: 'symbol', icon: '🅱️', desc: 'Solid mid-tier symbol.', cost: 7 },
            seven: { id: 'seven', name: 'Seven', type: 'symbol', icon: '7️⃣', desc: 'Rare and valuable symbol.', cost: 10 },
            diamond: { id: 'diamond', name: 'Diamond', type: 'symbol', icon: '💎', desc: 'Doubles a winning score.', cost: 12 },
            jester: { id: 'jester', name: 'Jester', type: 'joker', icon: '🤹', desc: 'Winning hands earn +$2.', cost: 9, effect: (payout) => {
                if (payout.score > 0) {
                    payout.money += 2;
                    return 'Jester tips +$2';
                }
            } },
            midas: { id: 'midas', name: 'Midas Touch', type: 'joker', icon: '👑', desc: 'Each BAR in a hand grants +10 score.', cost: 12, effect: (payout, cards) => {
                const bonus = cards.filter(card => card.id === 'bar').length * 10;
                if (bonus > 0) {
                    payout.score += bonus;
                    return `Midas bonus +${bonus} score`;
                }
            } },
            clover: { id: 'clover', name: 'Lucky Clover', type: 'joker', icon: '🍀', desc: '20% chance to gain +$1 on a miss.', cost: 8, effect: (payout) => {
                if (payout.score === 0 && Math.random() < 0.2) {
                    payout.money += 1;
                    return 'Lucky Clover +$1';
                }
            } },
            greased_lever: { id: 'greased_lever', name: 'Greased Lever', type: 'joker', icon: '🛠️', desc: 'Gain +2 draws every blind.', cost: 11, spinBonus: 2 },
            silver_star: { id: 'silver_star', name: 'Silver Star', type: 'joker', icon: '⭐', desc: '+15 score for winning with Bells.', cost: 11, effect: (payout, cards) => {
                if (payout.score > 0 && cards.some(card => card.id === 'bell')) {
                    payout.score += 15;
                    return 'Silver Star +15 score';
                }
            } },
        };

        const payoutTable = {
            cherry: [{ score: 5, money: 1 }, { score: 15, money: 2 }, { score: 35, money: 4 }],
            bell: [{ score: 0, money: 0 }, { score: 30, money: 3 }, { score: 60, money: 6 }],
            bar: [{ score: 0, money: 0 }, { score: 45, money: 5 }, { score: 90, money: 10 }],
            seven: [{ score: 0, money: 0 }, { score: 0, money: 0 }, { score: 140, money: 18 }],
            diamond: [{ score: 0, money: 0 }, { score: 0, money: 0 }, { score: 120, money: 15 }],
        };

        const blinds = [
            { score: 100, draws: 8 },
            { score: 250, draws: 8 },
            { score: 500, draws: 7 },
            { score: 900, draws: 7 },
            { score: 1400, draws: 6 },
        ];

        const HAND_SIZE = 5;
        const SELECTION_LIMIT = 3;

        const symbolIds = Object.values(cardPool).filter(card => card.type === 'symbol').map(card => card.id);
        const jokerIds = Object.values(cardPool).filter(card => card.type === 'joker').map(card => card.id);

        const state = {
            blindIndex: 0,
            score: 0,
            money: 5,
            drawsLeft: 0,
            hand: [],
            selection: [],
            jokers: [],
            reels: [],
            lastPayline: [],
            lastPayout: null,
            canDraw: true,
            canPlay: false,
            message: '',
            gameOver: false,
            shopOpen: false,
            shopChoices: [],
            pendingSymbol: null,
        };

        function createInitialReel() {
            return ['cherry', 'cherry', 'cherry', 'cherry', 'bar', 'bar', 'bell', 'bell', 'seven'];
        }

        function startGame() {
            state.blindIndex = 0;
            state.money = 5;
            state.jokers = [];
            state.reels = [createInitialReel(), createInitialReel(), createInitialReel()];
            state.lastPayline = [];
            state.lastPayout = null;
            state.gameOver = false;
            startBlind();
        }

        function startBlind() {
            const blind = blinds[state.blindIndex];
            state.score = 0;
            state.drawsLeft = blind.draws + getTotalSpinBonus();
            state.hand = [];
            state.selection = [];
            state.canDraw = true;
            state.canPlay = false;
            state.lastPayline = [];
            state.lastPayout = null;
            state.message = `Blind ${state.blindIndex + 1}: Score ${blind.score} before you run out of draws.`;
            updateUI();
        }

        function getTotalSpinBonus() {
            return state.jokers.reduce((bonus, jokerId) => {
                const joker = cardPool[jokerId];
                return bonus + (joker.spinBonus || 0);
            }, 0);
        }

        function drawHand() {
            if (!state.canDraw || state.gameOver || state.drawsLeft <= 0) return;
            const deck = shuffle([...state.reels[0], ...state.reels[1], ...state.reels[2]]);
            state.hand = [];
            for (let i = 0; i < HAND_SIZE && deck.length; i++) {
                state.hand.push(deck.pop());
            }
            state.selection = [];
            state.canDraw = false;
            state.canPlay = true;
            state.drawsLeft -= 1;
            state.message = 'Select exactly three cards to play.';
            updateUI();
        }

        function toggleSelection(index) {
            if (!state.canPlay || state.gameOver) return;
            const currentIndex = state.selection.indexOf(index);
            if (currentIndex >= 0) {
                state.selection.splice(currentIndex, 1);
            } else if (state.selection.length < SELECTION_LIMIT) {
                state.selection.push(index);
            }
            updateSelectionDetails();
            updateUIControls();
        }

        function playHand() {
            if (!state.canPlay || state.selection.length !== SELECTION_LIMIT || state.gameOver) return;
            const orderedSelection = [...state.selection].sort((a, b) => a - b);
            const cards = orderedSelection.map(idx => cardPool[state.hand[idx]]);
            let payout = calculatePayout(cards);
            payout = applyJokerEffects(payout, cards);

            state.score += payout.score;
            state.money += payout.money;
            state.lastPayline = cards;
            state.lastPayout = payout;
            state.message = payout.displayMessage;

            state.hand = [];
            state.selection = [];
            state.canPlay = false;
            state.canDraw = state.drawsLeft > 0;

            updateUI();
            checkBlindState();
        }

        function calculatePayout(cards) {
            const counts = {};
            let hasDiamond = false;
            cards.forEach((card, index) => {
                counts[card.id] = (counts[card.id] || { count: 0, indices: [] });
                counts[card.id].count += 1;
                counts[card.id].indices.push(index);
                if (card.id === 'diamond') hasDiamond = true;
            });

            let best = { score: 0, money: 0, indices: [], symbol: null, notes: [] };
            Object.entries(counts).forEach(([id, data]) => {
                const table = payoutTable[id];
                if (!table) return;
                const tier = table[data.count - 1];
                if (!tier) return;
                const score = tier.score;
                const money = tier.money;
                if (score > best.score || (score === best.score && money > best.money)) {
                    best = { score, money, indices: data.indices, symbol: id, notes: [] };
                }
            });

            if (best.score > 0 && hasDiamond && best.symbol !== 'diamond') {
                best.score *= 2;
                best.notes.push('Diamond doubles the score');
                cards.forEach((card, index) => {
                    if (card.id === 'diamond') {
                        best.indices.push(index);
                    }
                });
            }

            const message = best.score > 0
                ? `Win! +${best.score} score${best.money > 0 ? ` & +$${best.money}` : ''}`
                : (best.money > 0 ? `You found $${best.money}` : 'No win this time.');

            return {
                score: best.score,
                money: best.money,
                winningIndices: [...new Set(best.indices)],
                notes: best.notes,
                displayMessage: message,
            };
        }

        function applyJokerEffects(payout, cards) {
            const notes = [...(payout.notes || [])];
            state.jokers.forEach(jokerId => {
                const joker = cardPool[jokerId];
                if (typeof joker.effect === 'function') {
                    const note = joker.effect(payout, cards);
                    if (note) notes.push(note);
                }
            });
            payout.notes = notes;
            if (notes.length > 0) {
                payout.displayMessage += ` \u2014 ${notes.join(' · ')}`;
            }
            return payout;
        }

        function checkBlindState() {
            const blind = blinds[state.blindIndex];
            if (state.score >= blind.score) {
                if (state.blindIndex === blinds.length - 1) {
                    endRun(true);
                } else {
                    openShop();
                }
                return;
            }

            if (state.drawsLeft <= 0 && !state.canDraw && !state.canPlay) {
                endRun(false);
            }
        }

        function openShop() {
            state.shopOpen = true;
            state.canDraw = false;
            state.canPlay = false;
            state.shopChoices = generateShopChoices();
            state.pendingSymbol = null;
            elements.shopIntro.textContent = 'Spend your coins to power up for the next blind.';
            updateShopUI();
            openModal(elements.shopModal);
        }

        function generateShopChoices() {
            const choices = [];
            const availableSymbols = shuffle(symbolIds.slice());
            const availableJokers = shuffle(jokerIds.filter(id => !state.jokers.includes(id)));

            while (choices.length < 4 && (availableSymbols.length || availableJokers.length)) {
                if (choices.length < 2 && availableSymbols.length) {
                    choices.push({ id: availableSymbols.shift(), state: 'available' });
                } else if (availableJokers.length) {
                    choices.push({ id: availableJokers.shift(), state: 'available' });
                } else if (availableSymbols.length) {
                    choices.push({ id: availableSymbols.shift(), state: 'available' });
                } else {
                    break;
                }
            }
            return choices;
        }

        function attemptPurchase(choice) {
            const card = cardPool[choice.id];
            if (!card || state.pendingSymbol || choice.state !== 'available') return;
            if (state.money < card.cost) {
                elements.shopIntro.textContent = "You can't afford that yet.";
                return;
            }
            state.money -= card.cost;
            if (card.type === 'joker') {
                state.jokers.push(card.id);
                choice.state = 'owned';
                elements.shopIntro.textContent = `${card.name} joins your crew!`;
            } else {
                state.pendingSymbol = { choice, cardId: card.id };
                choice.state = 'pending';
                elements.reelPickerName.textContent = `Choose a reel for ${card.name}`;
                elements.reelPicker.hidden = false;
            }
            updateShopUI();
            updateUI();
        }

        function assignSymbolToReel(reelIndex) {
            if (!state.pendingSymbol) return;
            const { cardId, choice } = state.pendingSymbol;
            state.reels[reelIndex].push(cardId);
            choice.state = 'placed';
            choice.reel = reelIndex + 1;
            elements.shopIntro.textContent = `${cardPool[cardId].name} added to Reel ${reelIndex + 1}!`;
            state.pendingSymbol = null;
            elements.reelPicker.hidden = true;
            updateShopUI();
            updateUI();
        }

        function cancelPendingSymbol() {
            if (!state.pendingSymbol) return;
            const { cardId, choice } = state.pendingSymbol;
            state.money += cardPool[cardId].cost;
            choice.state = 'available';
            state.pendingSymbol = null;
            elements.reelPicker.hidden = true;
            elements.shopIntro.textContent = 'Purchase cancelled.';
            updateShopUI();
            updateUI();
        }

        function finishShop() {
            if (state.pendingSymbol) return;
            closeModal(elements.shopModal);
            state.shopOpen = false;
            state.blindIndex += 1;
            if (state.blindIndex >= blinds.length) {
                endRun(true);
            } else {
                startBlind();
            }
        }

        function skipShop() {
            if (state.pendingSymbol) return;
            elements.shopIntro.textContent = 'Skipping the shop... good luck out there!';
            finishShop();
        }

        function endRun(victory) {
            state.gameOver = true;
            state.canDraw = false;
            state.canPlay = false;
            closeModal(elements.shopModal);
            elements.endTitle.textContent = victory ? 'Jackpot!' : 'Run Over';
            elements.endMessage.textContent = victory ? 'You conquered every blind. The casino bows to you.' : 'You ran out of draws before meeting the blind.';
            elements.endBlind.textContent = victory ? blinds.length : state.blindIndex + 1;
            elements.endCoins.textContent = `$${state.money}`;
            openModal(elements.endModal);
        }

        function restartGame() {
            closeModal(elements.endModal);
            state.shopOpen = false;
            startGame();
        }

        function updateUI() {
            const blind = blinds[state.blindIndex];
            elements.scoreValue.textContent = `${state.score} / ${blind.score}`;
            elements.drawsValue.textContent = state.drawsLeft;
            elements.blindValue.textContent = state.blindIndex + 1;
            elements.moneyValue.textContent = `$${state.money}`;
            elements.selectionStatus.textContent = `${state.selection.length} / ${SELECTION_LIMIT} selected`;

            renderHand();
            renderJokers();
            renderReels();
            renderPayline();
            updateMessage();
            updateUIControls();

            if (state.shopOpen) {
                updateShopUI();
            }
        }

        function renderHand() {
            elements.handGrid.innerHTML = '';
            if (state.hand.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'info-text';
                empty.textContent = state.canDraw ? 'Tap Draw Hand to see your next cards.' : 'Play a hand to draw again.';
                elements.handGrid.appendChild(empty);
                elements.cardDetails.textContent = '';
                return;
            }

            state.hand.forEach((cardId, index) => {
                const card = cardPool[cardId];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'card hand-card';
                button.dataset.index = index;
                button.innerHTML = `<span class="card-icon">${card.icon}</span><span class="card-name">${card.name}</span><span class="card-desc">${card.desc}</span>`;
                if (state.selection.includes(index)) {
                    button.classList.add('selected');
                }
                button.addEventListener('click', () => toggleSelection(index));
                button.addEventListener('focus', () => showCardDetails(card));
                button.addEventListener('mouseenter', () => showCardDetails(card));
                elements.handGrid.appendChild(button);
            });

            if (state.selection.length === 0 && state.hand.length > 0) {
                showCardDetails(cardPool[state.hand[0]]);
            }
        }

        function showCardDetails(card) {
            if (!card) {
                elements.cardDetails.textContent = '';
                return;
            }
            elements.cardDetails.textContent = `${card.name}: ${card.desc}`;
        }

        function updateSelectionDetails() {
            const latest = state.selection[state.selection.length - 1];
            if (typeof latest === 'number') {
                showCardDetails(cardPool[state.hand[latest]]);
            } else if (state.hand.length > 0) {
                showCardDetails(cardPool[state.hand[0]]);
            } else {
                showCardDetails(null);
            }
        }

        function renderJokers() {
            elements.jokerTray.innerHTML = '';
            if (state.jokers.length === 0) {
                const span = document.createElement('span');
                span.className = 'joker-empty';
                span.textContent = 'No jokers yet. Visit the shop after a win to recruit one.';
                elements.jokerTray.appendChild(span);
            } else {
                state.jokers.forEach(jokerId => {
                    const joker = cardPool[jokerId];
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.minHeight = '120px';
                    card.innerHTML = `<span class="card-icon">${joker.icon}</span><span class="card-name">${joker.name}</span><span class="card-desc">${joker.desc}</span>`;
                    elements.jokerTray.appendChild(card);
                });
            }
            const label = state.jokers.length === 1 ? 'joker' : 'jokers';
            elements.jokerCount.textContent = `${state.jokers.length} ${label}`;
        }

        function renderReels() {
            elements.reelSummary.innerHTML = '';
            state.reels.forEach((reel, index) => {
                const reelChip = document.createElement('span');
                reelChip.className = 'chip';
                reelChip.textContent = `Reel ${index + 1}: ${reel.length} cards`;
                elements.reelSummary.appendChild(reelChip);
            });
        }

        function renderPayline() {
            elements.paylineTrack.innerHTML = '';
            if (state.lastPayline.length === 0) {
                for (let i = 0; i < 3; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'payline-slot';
                    elements.paylineTrack.appendChild(slot);
                }
                elements.paylineInfo.textContent = 'Play a hand to see results.';
                return;
            }
            state.lastPayline.forEach((card, index) => {
                const slot = document.createElement('div');
                slot.className = 'payline-slot';
                if (state.lastPayout?.winningIndices?.includes(index)) {
                    slot.classList.add('win');
                }
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.innerHTML = `<span class="card-icon">${card.icon}</span><span class="card-name">${card.name}</span>`;
                slot.appendChild(cardEl);
                elements.paylineTrack.appendChild(slot);
            });
            elements.paylineInfo.textContent = state.lastPayout?.displayMessage || '';
        }

        function updateMessage() {
            elements.messageBar.textContent = state.message || '';
        }

        function updateUIControls() {
            elements.drawButton.disabled = !state.canDraw || state.gameOver;
            elements.playButton.disabled = !state.canPlay || state.selection.length !== SELECTION_LIMIT || state.gameOver;
        }

        function updateShopUI() {
            elements.shopMoney.textContent = `$${state.money}`;
            elements.shopItems.innerHTML = '';

            if (state.shopChoices.length === 0) {
                elements.shopEmpty.hidden = false;
            } else {
                elements.shopEmpty.hidden = true;
                state.shopChoices.forEach(choice => {
                    const card = cardPool[choice.id];
                    const row = document.createElement('div');
                    row.className = 'shop-item';

                    const preview = document.createElement('div');
                    preview.className = 'card';
                    preview.style.minHeight = '110px';
                    preview.innerHTML = `<span class="card-icon">${card.icon}</span>`;

                    const info = document.createElement('div');
                    info.className = 'shop-info';
                    info.innerHTML = `<strong>${card.name}</strong><span class="shop-status">${card.desc}</span>`;

                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'shop-buy';

                    if (choice.state === 'available') {
                        button.textContent = `Buy for $${card.cost}`;
                        button.disabled = state.money < card.cost || !!state.pendingSymbol;
                        button.addEventListener('click', () => attemptPurchase(choice));
                    } else if (choice.state === 'pending') {
                        button.textContent = 'Waiting for reel...';
                        button.disabled = true;
                    } else if (choice.state === 'placed') {
                        button.textContent = `Added to Reel ${choice.reel}`;
                        button.disabled = true;
                    } else {
                        button.textContent = 'Purchased';
                        button.disabled = true;
                    }

                    info.appendChild(button);
                    row.appendChild(preview);
                    row.appendChild(info);
                    elements.shopItems.appendChild(row);
                });
            }

            elements.reelPicker.hidden = !state.pendingSymbol;
            elements.shopContinue.disabled = !!state.pendingSymbol;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function openModal(modal) {
            if (!modal) return;
            modal.hidden = false;
            document.body.classList.add('modal-open');
        }

        function closeModal(modal) {
            if (!modal) return;
            modal.hidden = true;
            if (document.querySelectorAll('.modal:not([hidden])').length === 0) {
                document.body.classList.remove('modal-open');
            }
        }

        elements.drawButton.addEventListener('click', drawHand);
        elements.playButton.addEventListener('click', playHand);
        elements.helpButton.addEventListener('click', () => openModal(elements.helpModal));
        elements.closeHelp.addEventListener('click', () => closeModal(elements.helpModal));
        elements.restartButton.addEventListener('click', restartGame);
        elements.shopContinue.addEventListener('click', finishShop);
        elements.skipShop.addEventListener('click', skipShop);
        elements.reelCancel.addEventListener('click', cancelPendingSymbol);
        elements.reelPickerButtons.forEach(button => button.addEventListener('click', (event) => {
            assignSymbolToReel(Number(event.currentTarget.dataset.reel));
        }));

        elements.shopModal.addEventListener('click', (event) => {
            if (event.target === elements.shopModal) {
                elements.shopIntro.textContent = 'Take your time! Choose wisely before the next blind.';
            }
        });

        elements.helpModal.addEventListener('click', (event) => {
            if (event.target === elements.helpModal) {
                closeModal(elements.helpModal);
            }
        });

        startGame();
    });
    </script>
</body>
</html>
